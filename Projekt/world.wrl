#VRML V2.0 utf8

# Skifahrer Extern Proto
EXTERNPROTO Skifahrer [
    field SFColor farbe
    field SFString desc
]
[
    "skifahrer.wrl"
]


# Enternem vom default Licht
NavigationInfo {
    headlight FALSE
}


# directionalLight
DEF DLight DirectionalLight {
    color 1 1 1
    intensity 0.8
    on TRUE
    direction 0 -1 0
}


# Definition Skilift-Stuetzen 
DEF Skilift Transform {
    scale 1 0.8 1
    translation 3.5 1.8 -4.5
    children [
        # Stange nach oben
        Transform {
            children [
                Shape {
                    appearance Appearance {
                        material Material {
                            diffuseColor 0.31 0.31 0.31 
                        } 
                    }
                    geometry Box {
                        size 0.3 4 0.3
                    }
                }
            ]
        }
        # Stange nach vorne
        Transform {
            translation 0 1.8 0.8 
            children [
                Shape {
                    appearance Appearance {
                        material Material {
                            diffuseColor 0.31 0.31 0.31 
                        } 
                    }
                    geometry Box {
                        size 0.3  0.2 1.5 
                    }
                }
            ]
        }
        # Kabelaufhaengung 
        Transform {
            translation 0 1.5 1.2
            children [
                Shape {
                    appearance Appearance {
                        material Material {
                            diffuseColor 0.31 0.31 0.31 
                        } 
                    }
                    geometry Box {
                        size 0.3  0.4 0.3
                    }
                }
            ]
        }
        # Lampe
        Transform {
            translation 0 1.8 1.6
            rotation 1 0 0 -0.45
            children [
                Shape {
                    appearance Appearance {
                        material Material {
                            diffuseColor 0.31 0.31 0.31
                        }
                    }
                    geometry Cone {
                        bottomRadius 0.15 
                        height 0.2 
                    }
                }
            ]
        }
        Transform {
            translation 0 1.8 0
            rotation 1 0 0 -0.8
            children [
                DEF SPOT SpotLight {
                    intensity 0.7
                    direction 0 -1 0
                    color 0 1 0 
                    radius 100 
                    beamWidth 0.523 # 30 grad
                    cutOffAngle 0.349 # 20 grad
                    on FALSE
                }
            ]
        }
    ]
}


# Definition Bäume
DEF Baum Transform {
    scale 0.7 0.8 0.7
    children [
        # Baum
        Transform {
            translation 0 1.1 0 
            children [
                Shape {
                    appearance Appearance {
                        material Material {
                        }
                        texture ImageTexture {
                            url "tree-trunk.jpg"
                        }
                    }
                    geometry Cylinder {
                        height 2 
                        radius 0.3 
                    }
                }
           ]
        }
        # Blätter
        Transform {
            translation 0 1.8 0 
            children [
                # Blatt 1
                Transform {
                    translation 0 1 0
                    children [
                        Shape {
                            appearance Appearance {
                                material Material {
                                }
                                texture ImageTexture {
                                    url "pine.jpg"
                                }
                            }
                            geometry Cone {
                                bottomRadius 1 
                                height 1
                            }
                        }
                    ]
                }
                # Blatt 2 
                Transform {
                    translation 0 0.5 0
                    children [
                        Shape {
                            appearance Appearance {
                                material Material {
                                }
                                texture ImageTexture {
                                    url "pine.jpg"
                                }
                            }
                            geometry Cone {
                                bottomRadius 1.2 
                                height 1
                            }
                        }
                    ]
                }
                # Blatt 3 
                Transform {
                    translation 0 0 0
                    children [
                        Shape {
                            appearance Appearance {
                                material Material {
                                }
                                texture ImageTexture {
                                    url "pine.jpg"
                                }
                            }
                            geometry Cone {
                                bottomRadius 1.4 
                                height 1
                            }
                        }
                    ]
                }
           ]
        }
    ]
}

Transform {
    children [
        # Gerade
        Transform {
            children [
                Shape {
                    appearance Appearance {
                        material Material {
                            diffuseColor 1 1 1
                        }
                    }
                    geometry Box {
                            size 8 0.5 10 
                    }
                }
           ]
        }
        # Hang
        Transform {
            translation 9.5 3.2 0 
            rotation 0 0 1 0.524
            scale 1.3 1 1
            children [
                Shape {
                    appearance Appearance {
                        material Material {
                            diffuseColor 1 1 1
                        }
                    }
                    geometry Box {
                        size 10 0.5 10 
                    }
                }
           ]
        }
        # Haus
        Transform {
            scale 0.8 0.8 0.8
            translation 0 0.8 -3
            children [
                # Haus Box
                Transform {
                    children [
                        Shape {
                            appearance Appearance {
                                material Material { }
                                texture ImageTexture {
                                        url "brick-wall.jpg"
                                }
                            }
                            geometry Box {
                                size 2.5 1.5 2.0
                            }
                        }
                    ]
                }
                # Haus Dach
                Transform {
                    translation -1.5 0.5 0 
                    children [
                        Shape {
                            appearance Appearance {
                                material Material {
                                    diffuseColor 0.67 0.34 0.35
                                } 
                                texture ImageTexture {
                                    url "roof.jpg"
                                }
                            }
                            geometry IndexedFaceSet {
                                coord Coordinate {
                                    point [
                                        # vorne
                                        0 0 1.5, # 0 links unten
                                        3 0 1.5, # 1 rechts unten
                                        3 1 0, # 2 rechts oben
                                        0 1 0, # 3 links oben
                                        # hinten
                                        0 0 -1.5, # 4 links unten
                                        3 0 -1.5,  # 5 rechts unten
                                        3 1 0, # 6 rechts oben 
                                        0 1 0 # 7 links oben
                                    ]
                                }
                                coordIndex [
                                    0 1 2 3 -1
                                    7 6 5 4 -1
                                    0 3 4 -1
                                    1 5 2 -1
                                    4 5 1 0 -1
                                ]     
                            }
                        }    
                    ]
                }
            ]
        }
        #Skilift Pole 2
        Transform {
            translation 2.5 1.2 0 
            children [
                USE Skilift
            ]
        }
        #Skilift Pole 3
        Transform {
            translation 5 2.6 0 
            children [
                USE Skilift
            ]
        }
        #Skilift Pole 4
        Transform {
            translation 7.5 4 0 
            children [
                USE Skilift
            ]
        }
        #Skilift Pole 5
        Transform {
            translation 10 5.4 0 
            children [
                USE Skilift
            ]
        }
        # Kabel
        Transform {
            rotation 0 0 1 -1.07
            translation 8.6 5.75 -3.28
            children [
                Shape {
                    appearance Appearance {
                        material Material {
                            diffuseColor 0.2 0.2 0.2
                        } 
                    }
                    geometry Cylinder {
                        radius 0.05
                        height 11.4 
                        bottom TRUE
                        side TRUE
                    }
                }
            ]
        }
        # Lift
        DEF Lift Transform {
            children [
                # Stange
                Transform {
                    translation 3.6 2 -3.28
                    children [
                        Shape {
                            appearance Appearance {
                                material Material {
                                    diffuseColor 0.5 0.5 0.5
                                }
                            }
                            geometry Cylinder {
                                radius 0.05
                                height 2
                                bottom TRUE
                                side TRUE
                            }
                        }

                    ]
                }
            ]
        }

        # Baum 2
        Transform {
            translation -1 0 2
            scale 0.6 0.9 0.6 
            children [
                USE Baum
            ]
        } 
        # Baum 3
        Transform {
            translation -3 0 0 
            scale 0.6 1.3 0.6
            children [
                USE Baum
            ]
        } 
        # Baum 4
        Transform {
            translation 8 2.3 4.3
            scale 0.6 0.8 0.6
            children [
                USE Baum
            ]
        } 
        # Baum 5
        Transform {
            translation 5 0.8 -4.5
                scale 0.6 0.8 0.6 
            children [
                USE Baum
            ]
        } 
        # Baum 6
        Transform {
                translation 6 1.2 3.5 
            scale 0.8 0.9 1
            children [
                USE Baum
            ]
        } 
        # Baum 7
        Transform {
            translation -3 0 4 
            scale 0.7 0.9 0.7 
            children [
                USE Baum
            ]
        } 
        # Baum 8
        Transform {
            translation 0 0 4
            scale 0.9 1.2 0.9
            children [
                USE Baum
            ]
        } 
        # Baum 9
        Transform {
            translation 3 0 4
            scale 0.8 0.9 0.8 
            children [
                USE Baum
            ]
        } 
        # Baum 10 
        Transform {
            translation -3 0 -4 
            scale 0.8  1.2 0.8
            children [
                USE Baum
            ]
        } 
        # Skifahrer 
        Transform {
            translation 14 6.1 -2 
            scale 0.2 0.2 0.2
            rotation 0 1 0 -1.590796327
            children [
                # Skifahrer 1 
                DEF skier Transform {
                    rotation 1 0 0 0.525
                    children [ 
                        DEF skierP Transform {
                            children [
                                DEF skierTouch TouchSensor { }
                                Skifahrer { }
                                
                            ]
                        }
                    Transform {
                            children [
                                DEF Fackellicht PointLight  {
                                    intensity 0.75
                                    color 1 0 0
                                    radius 10
                                    location 1 4 3
                                    on FALSE
                                }
                            ]
                        }  
                    ]
                }
                # Skifahrer 2 
                Transform {
                    rotation 1 0 0 0.5
                    translation 8 0 0
                    children [
                        Skifahrer {
                            farbe 0.4 0.8 0.3
                            desc "Skifahrer2"
                        }
                    ]
                }
                # Skifahrer 3 
                Transform {
                    rotation 1 0 0 0.5
                    translation 12 0 0
                    children [
                        Skifahrer {
                            farbe 0.8 0.3 0.4
                            desc "Skifahrer3"
                        }
                    ]
                }
                # Skifahrer 4 
                Transform {
                    rotation 1 0 0 0.5
                    translation 16 0 0
                    children [
                        Skifahrer {
                            farbe 0 1 1 
                            desc "Skifahrer4"
                        }
                    ]
                }
            ]
        }
        # Schlitten
        Transform {
            translation 14 6.1 -2.2 
            children [
                Transform {
                    rotation 0 0 1 0.525
                    children [
                        Shape {
                            appearance Appearance {
                                material Material {
                                    diffuseColor 0.35 0.22 0.16
                                }
                            }
                            geometry Box {
                                size 0.6 0.6 0.4
                            }
                        }
                    ]
                }
            ]
        }
        # Werbe-Video-Wand
        Transform {
            translation 14 7 3
            rotation 0 1 0 -1.7
            children [
                # Werbefläche
                Transform {
                    children [
                        Transform {
                            children [
                                Shape {
                                    appearance Appearance {
                                        texture MovieTexture {
                                            loop TRUE
                                            url "ski.gif"
                                            startTime 1
                                        }
                                    }
                                    geometry IndexedFaceSet {
                                        coord Coordinate {
                                            point [
                                                # Vorderseite
                                                0 0 0.2     # 0
                                                1.7 0 0.2   # 1
                                                1.7 1.7 0.2 # 2
                                                0 1.7 0.2   # 3

                                            ]
                                        }
                                        coordIndex [
                                            0 1 2 3 -1 
                                        ]
                                    }
                                }
                            ]
                        }
                        Transform {
                            children [
                                Shape {
                                    appearance Appearance {
                                        material Material { }
                                    }
                                    geometry IndexedFaceSet {
                                        coord Coordinate {
                                            point [
                                                # Vorderseite
                                                0 0 0.2     # 0
                                                1.7 0 0.2   # 1
                                                1.7 1.7 0.2 # 2
                                                0 1.7 0.2   # 3
                                                #Rückseite
                                                0 0 0       # 4
                                                1.7 0 0     # 5
                                                1.7 1.7 0   # 6
                                                0 1.7 0     # 7

                                            ]
                                        }
                                        coordIndex [
                                            7 6 5 4 -1
                                            1 5 6 2 -1
                                            2 6 7 3 -1
                                            0 3 7 4 -1
                                            0 4 5 1 -1
                                        ]
                                    }
                                }
                            ]
                        }
                    ]
                }
                # Standbeine
                Transform {
                    translation 0 -0.65 0
                    children [
                        Transform {
                            translation 0.3 0 0.1
                            children [
                                Shape {
                                    appearance Appearance {
                                        material Material { }
                                    }
                                    geometry Box {
                                        size 0.2 1.3 0.2
                                    }
                                }
                            ]
                        }
                        Transform {
                            translation 1.4 0 0.1
                            children [
                                Shape {
                                    appearance Appearance {
                                        material Material { }
                                    }
                                    geometry Box {
                                        size 0.2 1.3 0.2
                                    }
                                }
                            ]
                        }
                    ]
                }
            ]
        }
    ]
}      

#### Viewpoints ####
# Front
Viewpoint {
    description "Front"
    position -12 3.5 0
    orientation 0 1 0 -1.59079633
}

# side
Viewpoint {
    description "Side"
    position 6 3.5 20 
}

# Vogelperspektive
Viewpoint {
    description "Vogelperspektive"
    position 6 25 0
    orientation 1 0 0 -1.59079633
}

# backside
Viewpoint {
    description "Backside"
    position 6 3.5 -20 
    orientation 0 1 0 -3.14159265
}
    
# action
Transform {
    translation 21 11 -10 
    rotation 0 0 1 0.3
    children [
        Viewpoint {
            description "Action"
            orientation 0 1 0 1.59079633
        }
    ]
}

#### Background ####
Background {
    groundAngle   1.5
    groundColor   [ 1 1 1,
                  1 1 1 ]
    skyAngle      [ 1.047, 2.094 ]
    skyColor      [ 0.1 0.1 0.5,
                  0.2 0.2 0.6,
                  0.6 0.6 0.7 ]
    backUrl "bg.jpg"
    leftUrl "bg.jpg"
    frontUrl "bg.jpg"
    rightUrl "bg.jpg"   
}


#### Licht ####
# Schalter für Scheinwerfer
Transform {
    translation 2 0.4 0
    children [
        DEF ScheinwerferSchalter TouchSensor { }
        Shape {
            appearance Appearance {
                material Material {
                    diffuseColor 0.1 0.6 0.1
                    emissiveColor 0.1 0.6 0.1
                }
            }
            geometry Sphere {
                radius 0.2
            }
        }
    ]
}
# Schalter für Nacht
Transform {
    translation 2 0.4 0.5
    children [
        DEF LichtSchalter TouchSensor { }
        Shape {
            appearance Appearance {
                material Material {
                    diffuseColor 0.1 0.1 0.6
                    emissiveColor 0.1 0.1 0.6
                }
            }
            geometry Sphere {
                radius 0.2
            }
        }
    ]
}

# Schalter für Fackel
Transform {
    translation 2 0.4 1
    children [
        DEF FackelSchalter TouchSensor { }
        Shape {
            appearance Appearance {
                material Material {
                    diffuseColor 0.6 0.1 0.1
                    emissiveColor 0.6 0.1 0.1
                }
            }
            geometry Sphere {
                radius 0.2
            }
        }
    ]
}

# code from: http://tecfa.unige.ch/guides/vrml/vrmlman/node23.html
# Scheinwerfer
DEF lightScript Script {
    eventIn SFBool lightIsActive
    eventOut SFBool fixLightState
    field SFBool state FALSE
   
    url ["javascript:
        function lightIsActive(active) {
            if (active) {
                if (state == FALSE) {
                    state = TRUE;
                fixLightState = TRUE;
                }
                else {
                    state = FALSE;
                    fixLightState = FALSE;
                }
            }
        }"
    ]
}

# Headlight
DEF lightScript2 Script {
    eventIn SFBool lightIsActive
    eventOut SFBool fixLightState
    field SFBool state TRUE

    url ["javascript:
        function lightIsActive(active) {
            if (active) {
                if (state == FALSE) {
                    state = TRUE;
                fixLightState = TRUE;
                }
                else {
                    state = FALSE;
                    fixLightState = FALSE;
                }
            }
        }"
    ]
}

# Fackel
DEF lightScript3 Script {
    eventIn SFBool lightIsActive
    eventOut SFBool fixLightState
    field SFBool state TRUE

    url ["javascript:
        function lightIsActive(active) {
            if (active) {
                if (state == FALSE) {
                    state = TRUE;
                fixLightState = TRUE;
                }
                else {
                    state = FALSE;
                    fixLightState = FALSE;
                }
            }
        }"
    ]
}


#### ANIMATIONS ####
# Timer
DEF timer TimeSensor {
    cycleInterval 30 
    loop FALSE
    startTime -1 
    stopTime 0
}

# Position der Liftstange
DEF piLift PositionInterpolator {
    key [
        0.81        # Lift start
        0.96        # Lift oben
    ]
    keyValue [
        0 0 0       # Start Lift
        10 5.5 0    # Ende Lift
    ]
}

# Position des Skifahrers
DEF pi PositionInterpolator {
    key [
            0           # 1 Startpunkt
            0.22        # Kurve 1 Sp
            0.221       # Änderung der Höhe (nur relevant für POS)
            0.40        # Änderung der Höhe (nur relevant für POS)
            0.43        # Kurve 2 Sp
            0.61        # Kurve 3 Sp
            0.62        # Übergang zur Ebene
            0.63        # Drehung um x-Achse auf Ebene
            0.7         # Am Haus
            0.76        # am Haus warten
            0.8         # Lift unten
            0.81        # Lift start
            0.96        # Lift oben
            1           # Endpunkt
    ]
    keyValue [
        0 0 0           # 1 Startpunkt
        20 -9.33 16.6   # Kurve 1 Sp
        20 -10 16.4     # Änderung der Höhe
        0 -18.5 31.5    # Änder der Höhe
        0 -18.7 33.2    # Kurve 2 Sp
        10 -27.99 49    # Kurve 3 Sp
        10 -28.2 50     # Übergang zur Ebene
        10 -29 52       # Drehung um x-Achse auf Ebene 
        -4 -29 60       # Am Haus
        -4 -29 60       # am Haus warten
        -4.5 -29 54     # Lift unten
        -4.5 -29.8 52   # Lift start
        -5 0 0          # Lift oben
        0 0 0           # Endpunkt
    ]
}
    
# Rotation y-Achse
DEF oi OrientationInterpolator {
    key [
        0           # Startpunkt
        0.1         # Rotation zur Kurve 1 hin
        0.19        # Kruve 1 Eintritt
        0.21        # Kurve 1 Sp
        0.23        # Kurve 1 Austritt
        0.41        # Kurve 2 E
        0.43        # Kurve 2 SP
        0.45        # Kurve 2 A
        0.58        # Kurve 3 E
        0.6         # Kurve 3 SP
        0.62        # Kurve 3 A
        0.62        # 2 Übergang zur Ebene
        0.63        # 3 Drehung um x-Achse auf Ebene
        0.7         # 4 Am Haus
        0.76        # 5 am Haus warten
        0.8         # 6 Lift unten
        0.81        # 7 Lift start
        0.96        # 8 Lift oben
        1           # 9 Endpunkt
    ]
    keyValue [
        0 0 0 0             # 1 Startpunkt
        0 1 0 0.9           # Rotation zur Kurve 1
        0 1 0 0.9           # Kruve 1 E
        0 1 0 -0.2          # Kurve 1 Sp
        0 1 0 -0.9          # Kurve 1 A
        0 1 0 -0.9          # Kurve 2 E
        0 1 0 0.2           # Kurve 2 Sp
        0 1 0 0.5           # Kurve 2 A
        0 1 0 0.5           # Kurve 3 E
        0 1 0 -0.2          # Kurve 3 Sp
        0 1 0 -0.9          # Kurve 3 A
        0 1 0 -0.9          # Übergang zur Ebene
        0 1 0 -0.8          # Drehung um x-Achse auf Ebene
        0 1 0 -1.570796327  # Am Haus
        0 1 0 -1.570796327  # am Haus warten
        0 1 0 -3.141592654  # Lift unten
        0 1 0 -3.141592654  # Lift start
        0 1 0 -3.141592654  # Lift oben
        0 0 0 3.141892654   # Endpunkt
    ]
}

# Rotation x-Achse
DEF oi2 OrientationInterpolator {
    key [
        0               # Startpunkt
        0.1             # Rotation zur Kurve 1 
        0.19            # Kruve 1 Eintritt
        0.21            # Kurve 1 Sp
        0.23            # Kurve 1 Austritt
        0.41            # Kurve 2 E
        0.43            # Kurve 2 Sp
        0.45            # Kurve 2 A
        0.58            # Kurve 3 E
        0.6             # Kurve 3 Sp
        0.62            # Kurve 3 A
        0.62            # Übergang zur Ebene
        0.63            # Drehung um x-Achse auf Ebene
        0.7             # Am Haus
        0.76            # am Haus warten
        0.8             # Lift unten
        0.81            # Lift start
        0.96            # Lift oben
        1               # Endpunkt
    ]
    keyValue [
        1 0 0 0.525     # Startpunkt
        1 0 0 0.3       # Rotation zur Kurve 1
        1 0 0 0.3       # Kruve 1 E
        1 0 0 0.4       # Kruve 1 Sp
        1 0 0 0.3       # Kruve 1 A
        1 0 0 0.3       # Kurve 2 E
        1 0 0 0.4       # Kurve 2 Sp
        1 0 0 0.3       # Kurve 2 A
        1 0 0 0.3       # Kurve 3 E
        1 0 0 0.4       # Kurve 3 Sp
        1 0 0 0.4       # Kurve 3 A
        1 0 0 0.4       # Übergang zur Ebene
        0 0 0 0         # Drehung um x-Achse auf Ebene
        0 0 0 0         # Am Haus
        0 0 0 0         # am Haus warten
        0 0 0 0         # Lift unten
        1 0 0 -0.525    # Lift start
        1 0 0 -0.525    # Lift oben
        1 0 0 0.525     # Endpunkt
    ]
}



#### ROUTES ####
# Lichtschalter - Scheinwerfer
ROUTE ScheinwerferSchalter.isActive TO lightScript.lightIsActive
ROUTE lightScript.fixLightState TO SPOT.set_on

# Lichtschalter - DirectionalLight
ROUTE LichtSchalter.isActive TO lightScript2.lightIsActive
ROUTE lightScript2.fixLightState TO DLight.set_on

ROUTE FackelSchalter.isActive TO lightScript3.lightIsActive
ROUTE lightScript3.fixLightState TO Fackellicht.set_on

#### Annimation ####
# connect timer to touchsensor
ROUTE skierTouch.touchTime TO timer.set_startTime

# connect timer to PositionInterpolator
ROUTE timer.fraction_changed TO pi.set_fraction
ROUTE timer.fraction_changed TO oi.set_fraction
ROUTE timer.fraction_changed TO oi2.set_fraction
ROUTE timer.fraction_changed TO piLift.set_fraction

# connect PositionInterporlator to object
ROUTE pi.value_changed TO skier.set_translation
ROUTE oi.value_changed TO skier.set_rotation
ROUTE oi2.value_changed TO skierP.set_rotation
ROUTE piLift.value_changed TO Lift.set_translation


